-- WALL MONITOR SCRIPT (Compact Keypad + Troll Mode)

-- 1. CONFIGURATION
local floors = {
    [1] = { name = "Lobby",   locked = false },
    [2] = { name = "Storage", locked = false },
    [3] = { name = "Roof",    locked = true, pin = "5555" }
}

-- 2. SETUP
local sides = rs.getSides()
local modemFound = false
for _, side in pairs(sides) do
    if peripheral.getType(side) == "modem" then
        rednet.open(side)
        modemFound = true
        break
    end
end
if not modemFound then pcall(rednet.open, "top") end

local mon = peripheral.find("monitor")
if not mon then error("No Monitor Found") end
mon.setTextScale(1)

-- 3. COLORS
local c_bg = colors.black
local c_text = colors.white
local c_lock = colors.red
local c_btn = colors.gray
local c_btn_text = colors.yellow
local c_pin_bg = colors.gray

-- 4. DRAWING HELPERS
local function drawBox(x, y, w, h, color)
    mon.setBackgroundColor(color)
    for i = y, y + h - 1 do
        mon.setCursorPos(x, i)
        mon.write(string.rep(" ", w))
    end
end

local function centerText(y, text, color)
    local w, h = mon.getSize()
    local x = math.floor((w - #text) / 2) + 1
    mon.setCursorPos(x, y)
    mon.setTextColor(color)
    mon.write(text)
end

local function drawMainMenu()
    mon.setBackgroundColor(c_bg)
    mon.clear()
    mon.setCursorPos(1,1)
    mon.setTextColor(colors.cyan)
    mon.write("== ELEVATOR ==")
    
    for i = 1, #floors do
        local f = floors[i]
        local yPos = 2 + (i * 2)
        mon.setCursorPos(2, yPos)
        if f.locked then
            mon.setTextColor(c_lock)
            mon.write("["..i.."] "..f.name.." [L]")
        else
            mon.setTextColor(c_text)
            mon.write("["..i.."] "..f.name)
        end
    end
end

-- 5. KEYPAD UI (Compact Version)
local function drawKeypadUI(targetName, currentPin)
    mon.setBackgroundColor(c_bg)
    mon.clear()
    
    mon.setCursorPos(2,2)
    mon.setTextColor(c_lock)
    mon.write("SECURE: " .. string.sub(targetName, 1, 10))
    
    -- PIN BOX
    mon.setCursorPos(2, 4)
    mon.setBackgroundColor(c_pin_bg)
    mon.setTextColor(colors.white)
    local masked = string.rep("*", #currentPin)
    mon.write(" " .. masked .. string.rep(" ", 4-#currentPin) .. " ")
    
    -- COMPACT KEYPAD (1 block high buttons)
    -- Start Y=6 so it fits on screen
    local startX = 2
    local startY = 6
    local btnW = 3
    local btnH = 1 
    local spacing = 1
    
    local layout = {
        {7, 8, 9},
        {4, 5, 6},
        {1, 2, 3},
        {-1, 0, -2}
    }
    
    for row = 1, 4 do
        for col = 1, 3 do
            local digit = layout[row][col]
            if digit >= -1 and digit ~= -2 then
                local x = startX + (col-1)*(btnW+spacing)
                local y = startY + (row-1)*(btnH+spacing)
                
                drawBox(x, y, btnW, btnH, c_btn)
                mon.setCursorPos(x+1, y)
                mon.setTextColor(c_btn_text)
                if digit == -1 then mon.write("C")
                else mon.write(tostring(digit)) end
            end
        end
    end
end

-- 6. TROLL SEQUENCE
local function runTrollSequence()
    mon.setBackgroundColor(c_bg)
    mon.clear()
    mon.setTextColor(colors.white)
    
    -- Troll Text
    mon.setCursorPos(1,2)
    mon.write("Did you actually put")
    mon.setCursorPos(1,3)
    mon.write("the right password?")
    mon.setCursorPos(1,5)
    mon.setTextColor(colors.gray)
    mon.write("Its nearly impossible")
    mon.setCursorPos(1,6)
    mon.write("to code a password")
    mon.setCursorPos(1,7)
    mon.write("guarded code for")
    mon.setCursorPos(1,8)
    mon.write("something this stupid")
    
    -- YES Button (Green)
    drawBox(2, 11, 5, 1, colors.lime)
    mon.setCursorPos(3, 11)
    mon.setTextColor(colors.black)
    mon.write("YES")
    
    -- NO Button (Red)
    drawBox(9, 11, 4, 1, colors.red)
    mon.setCursorPos(10, 11)
    mon.setTextColor(colors.white)
    mon.write("NO")
    
    while true do
        local e, s, x, y = os.pullEvent("monitor_touch")
        
        -- Check YES (x: 2-6, y: 11)
        if y == 11 and x >= 2 and x <= 6 then
            mon.setBackgroundColor(c_bg)
            mon.clear()
            centerText(6, "alright.. taking", colors.lime)
            centerText(7, "you to the roof...", colors.lime)
            sleep(3)
            mon.clear()
            centerText(6, "just kidding.", colors.red)
            sleep(2)
            return
        end
        
        -- Check NO (x: 9-12, y: 11)
        if y == 11 and x >= 9 and x <= 12 then
            return
        end
    end
end

-- 7. INPUT LOGIC
local function getKeypadTouch(x, y)
    -- Compact layout mapping
    -- Rows at: 6, 8, 10, 12
    local row = nil
    if y == 6 then row = 1
    elseif y == 8 then row = 2
    elseif y == 10 then row = 3
    elseif y == 12 then row = 4 end
    
    local col = nil
    if x >= 2 and x <= 4 then col = 1
    elseif x >= 6 and x <= 8 then col = 2
    elseif x >= 10 and x <= 12 then col = 3 end
    
    if row and col then
        if row==1 then return ({7,8,9})[col] end
        if row==2 then return ({4,5,6})[col] end
        if row==3 then return ({1,2,3})[col] end
        if row==4 then return ({-1,0,-2})[col] end
    end
    return nil
end

local function runPinProcess(target)
    local currentPin = ""
    local entering = true
    
    while entering do
        drawKeypadUI(target.name, currentPin)
        local event, side, x, y = os.pullEvent("monitor_touch")
        local digit = getKeypadTouch(x, y)
        
        if digit then
            if digit == -1 then currentPin = ""
            elseif digit >= 0 and #currentPin < 4 then
                currentPin = currentPin .. digit
                if #currentPin == 4 then
                    drawKeypadUI(target.name, currentPin)
                    sleep(0.2)
                    if currentPin == target.pin then
                        return true
                    else
                        -- TRIGGER TROLL HERE
                        runTrollSequence()
                        return false
                    end
                end
            end
        end
    end
    return false
end

-- 8. MAIN LOOPS
local myLabel = os.getComputerLabel()
local myFloorID = tonumber(myLabel)

local function runUI()
    while true do
        drawMainMenu()
        local event, side, x, y = os.pullEvent("monitor_touch")
        local idx = (y - 2) / 2
        
        if idx == math.floor(idx) and floors[idx] then
            local target = floors[idx]
            local auth = true
            
            mon.setCursorPos(2, y)
            mon.setTextColor(colors.yellow)
            mon.write(">> SELECT <<")
            sleep(0.1)
            
            if target.locked then
                auth = runPinProcess(target)
            end
            
            if auth then
                mon.setBackgroundColor(c_bg)
                mon.clear()
                mon.setCursorPos(2,5)
                mon.setTextColor(colors.lime)
                mon.write("CALLING: "..target.name)
                rednet.broadcast({ floor = idx }, "elevator_cmd")
                sleep(2)
            end
        end
    end
end

local function runBeacon()
    while true do
        local e, s, sCh, rCh, msg, dist = os.pullEvent("modem_message")
        if type(msg) == "table" and msg.sProtocol == "elevator_ping" and myFloorID then
             rednet.send(msg.nSender, { floor = myFloorID, range = dist }, "elevator_pong")
        end
    end
end

parallel.waitForAny(runUI, runBeacon)
