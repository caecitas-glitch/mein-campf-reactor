-- HALLWAY CLIENT (Screen + Wireless)
local monitor = peripheral.find("monitor")
peripheral.find("modem", rednet.open) -- Open Wireless Modem

-- [!] CONFIGURATION [!]
local SERVER_ID = 10     -- CHANGE THIS to your Master Server ID
local PIN_CODE = "1234"  -- Security PIN
local lockedFloors = { [-1]=true, [-2]=true }

-- GLOBAL VARS
local allFloors = {-2, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}
monitor.setTextScale(0.5) -- 0.5 Scale fits more buttons on 3x3
local w, h = monitor.getSize()
local state = "main" -- 'main', 'pin', 'moving'
local targetFloor = nil
local pinBuffer = ""

-- DRAWING UTILS
local function clear(c) monitor.setBackgroundColor(c); monitor.clear() end
local function center(y, text, bg, fg)
    monitor.setBackgroundColor(bg)
    monitor.setTextColor(fg)
    monitor.setCursorPos(math.floor((w-#text)/2)+1, y)
    monitor.write(text)
end

local function drawMain()
    clear(colors.black)
    center(2, "ELEVATOR CONTROL", colors.black, colors.white)
    
    local startX, startY = 3, 5
    local btnW, btnH = 6, 3
    local gap = 1
    
    for i, floor in ipairs(allFloors) do
        local col = (i-1) % 5
        local row = math.floor((i-1) / 5)
        local x = startX + (col * (btnW + gap))
        local y = startY + (row * (btnH + gap))
        
        local bg = colors.blue
        if lockedFloors[floor] then bg = colors.red end
        
        -- Draw Box
        monitor.setBackgroundColor(bg)
        monitor.setTextColor(colors.white)
        for k=0, btnH-1 do
            monitor.setCursorPos(x, y+k)
            monitor.write(string.rep(" ", btnW))
        end
        -- Draw Number
        monitor.setCursorPos(x + math.floor((btnW-(#tostring(floor)))/2), y + math.floor(btnH/2))
        monitor.write(tostring(floor))
    end
end

local function drawPin()
    clear(colors.gray)
    center(4, "SECURE ACCESS", colors.gray, colors.red)
    center(6, "FLOOR: " .. tostring(targetFloor), colors.gray, colors.white)
    
    monitor.setCursorPos(math.floor(w/2)-3, 9)
    monitor.setBackgroundColor(colors.black)
    monitor.write(" " .. string.rep("*", #pinBuffer) .. "_ ")
    
    center(h-2, "Type PIN on Keyboard", colors.gray, colors.lightGray)
end

local function sendRequest(f)
    clear(colors.black)
    center(h/2, "CALLING FLOOR " .. f, colors.black, colors.yellow)
    rednet.send(SERVER_ID, {floor=f}, "elevator_request")
    sleep(2)
    state = "main"
    pinBuffer = ""
    drawMain()
end

-- MAIN LOOP
drawMain()

while true do
    if state == "main" then
        local event, side, x, y = os.pullEvent("monitor_touch")
        -- Hit detection
        local startX, startY = 3, 5
        local btnW, btnH, gap = 6, 3, 1
        
        for i, floor in ipairs(allFloors) do
            local col = (i-1) % 5
            local row = math.floor((i-1) / 5)
            local bx = startX + (col * (btnW + gap))
            local by = startY + (row * (btnH + gap))
            
            if x >= bx and x < bx+btnW and y >= by and y < by+btnH then
                if lockedFloors[floor] then
                    targetFloor = floor
                    state = "pin"
                    pinBuffer = ""
                    drawPin()
                else
                    sendRequest(floor)
                end
            end
        end
        
    elseif state == "pin" then
        local event, char = os.pullEvent()
        
        -- Handle typing
        if event == "char" then
            if #pinBuffer < 4 then
                pinBuffer = pinBuffer .. char
                drawPin()
            end
            if pinBuffer == PIN_CODE then
                sendRequest(targetFloor)
            end
        end
        
        -- Handle backspace
        if event == "key" and char == keys.backspace then
            pinBuffer = string.sub(pinBuffer, 1, -2)
            drawPin()
        end
        
        -- Handle monitor touch to cancel
        if event == "monitor_touch" then
            state = "main"
            drawMain()
        end
    end
end
