-- SMART POCKET (Troll Edition)

if peripheral.getType("back") == "modem" then
    rednet.open("back")
else
    error("No Wireless Modem!")
end

-- CONFIGURATION (Reverted to 3 floors)
local floors = {
    [1] = { name = "Lobby",   locked = false },
    [2] = { name = "Storage", locked = false },
    [3] = { name = "Roof",    locked = true, pin = "5555" }
}

-- COLORS
local c_bg = colors.black
local c_text = colors.white
local c_lock = colors.red
local c_gps_btn = colors.orange

local function drawMenu()
    term.setBackgroundColor(c_bg)
    term.clear()
    term.setCursorPos(1,1)
    term.setTextColor(colors.cyan)
    print("== ELEVATOR ==")
    
    for i = 1, #floors do
        local f = floors[i]
        term.setCursorPos(2, 3+(i*2))
        if f.locked then
            term.setTextColor(c_lock)
            write("["..i.."] "..f.name.." [L]")
        else
            term.setTextColor(c_text)
            write("["..i.."] "..f.name)
        end
    end
    
    term.setCursorPos(2, 16)
    term.setBackgroundColor(c_gps_btn)
    term.setTextColor(colors.white)
    write(" [ O ] SCAN FOR ME ")
    term.setBackgroundColor(c_bg)
end

-- SCANNING
local function scanForFloor()
    term.setCursorPos(2, 18)
    term.setTextColor(colors.yellow)
    write("Pinging...")
    rednet.broadcast("LOCATE", "elevator_ping")
    
    local closestFloor = nil
    local shortestDist = 9999
    local timerID = os.startTimer(1)
    
    while true do
        local event, id, msg, protocol = os.pullEvent()
        if event == "timer" and id == timerID then break
        elseif event == "rednet_message" and protocol == "elevator_pong" then
            if type(msg) == "table" and msg.floor and msg.range then
                if msg.range < shortestDist then
                    shortestDist = msg.range
                    closestFloor = msg.floor
                end
            end
        end
    end
    return closestFloor
end

-- TROLL LOGIC
local function runTrollSequence()
    term.setBackgroundColor(c_bg)
    term.clear()
    term.setCursorPos(1,1)
    term.setTextColor(colors.white)
    
    print("Did you actually put")
    print("the right password?")
    print("Its nearly impossible")
    print("to code a password")
    print("guarded code for")
    print("something this stupid")
    
    term.setCursorPos(2, 10)
    term.setTextColor(colors.green)
    write("[ YES ]")
    
    term.setCursorPos(15, 10)
    term.setTextColor(colors.red)
    write("[ NO ]")
    
    while true do
        local event, btn, x, y = os.pullEvent("mouse_click")
        if y == 10 then
            -- YES
            if x >= 2 and x <= 8 then
                term.clear()
                term.setCursorPos(1,5)
                term.setTextColor(colors.lime)
                print("alright.. taking")
                print("you to the roof...")
                sleep(3)
                term.clear()
                term.setCursorPos(1,5)
                term.setTextColor(colors.red)
                print("just kidding.")
                sleep(2)
                return
            -- NO
            elseif x >= 15 and x <= 20 then
                return
            end
        end
    end
end

-- SECURITY
local function runPinProcess(target)
    term.setBackgroundColor(c_bg)
    term.clear()
    term.setCursorPos(1,1)
    print("SECURE: " .. target.name)
    print("Enter PIN:")
    term.setTextColor(colors.yellow)
    write("> ")
    local pin = read("*")
    
    if pin == target.pin then
        return true
    else
        runTrollSequence()
        return false
    end
end

-- MAIN LOOP
while true do
    drawMenu()
    local event, btn, x, y = os.pullEvent("mouse_click")
    
    local selected = nil
    local isScan = false 
    
    local listIdx = (y - 3) / 2
    if listIdx == math.floor(listIdx) and floors[listIdx] then
        selected = listIdx
        isScan = false
    end
    
    if y == 16 then
        local found = scanForFloor()
        if found then
            term.setCursorPos(2, 18)
            term.setTextColor(colors.lime)
            write("Found: " .. floors[found].name)
            sleep(1)
            selected = found
            isScan = true
        else
            term.setCursorPos(2, 18)
            term.setTextColor(colors.red)
            write("No Signal Found!")
            sleep(1)
        end
    end
    
    if selected then
        local target = floors[selected]
        local authorized = true
        
        if target.locked and not isScan then
            authorized = runPinProcess(target)
        end
        
        if authorized then
            rednet.broadcast({ floor = selected }, "elevator_cmd")
            term.clear()
            term.setCursorPos(1,5)
            term.setTextColor(colors.lime)
            print("ELEVATOR COMING")
            print("TO: "..target.name)
            sleep(2)
        end
    end
end
