-- POCKET ELEVATOR REMOTE
peripheral.find("modem", rednet.open)

-- [!] CONFIGURATION [!]
local SERVER_ID = 6
local PIN_CODE = "1234"

-- SAME FLOOR LIST AS WALL SCREENS
local floorList = {
    { id = 10, name = "Penthouse",    locked = false },
    { id = 9,  name = "Observatory",  locked = false },
    { id = 8,  name = "Hydroponics",  locked = false },
    { id = 7,  name = "Crew Qt.",     locked = false },
    { id = 6,  name = "Medical Bay",  locked = false },
    { id = 5,  name = "Cafeteria",    locked = false },
    { id = 4,  name = "Engineering",  locked = false },
    { id = 3,  name = "Workshop",     locked = false },
    { id = 2,  name = "Storage A",    locked = false },
    { id = 1,  name = "Storage B",    locked = false },
    { id = 0,  name = "Main Lobby",   locked = false },
    { id = -1, name = "Security",     locked = true },
    { id = -2, name = "The Vault",    locked = true },
}

-- UI VARS
local w, h = term.getSize()
local scroll = 0
local state = "list" -- 'list', 'pin', 'sent'
local target = nil
local pinBuf = ""

-- DRAWING TOOLS
local function clear(c) term.setBackgroundColor(c); term.clear() end
local function center(y, t, bg, fg)
    term.setBackgroundColor(bg); term.setTextColor(fg)
    term.setCursorPos(math.floor((w-#t)/2)+1, y)
    term.write(t)
end

local function drawList()
    clear(colors.black)
    -- Header
    term.setCursorPos(1,1); term.setBackgroundColor(colors.gray)
    term.clearLine(); center(1, "ELEVATOR REMOTE", colors.gray, colors.white)
    
    -- List
    local visibleCount = h - 2
    for i = 0, visibleCount - 1 do
        local idx = scroll + i + 1
        local item = floorList[idx]
        if item then
            local y = 2 + i + 1
            local bg = item.locked and colors.red or colors.blue
            if item.locked then bg = colors.brown end -- Darker red for pocket
            
            term.setBackgroundColor(bg)
            term.setCursorPos(1, y)
            term.clearLine()
            
            term.setTextColor(colors.white)
            term.write(" " .. item.name)
            
            -- Floor Number on right
            local numStr = tostring(item.id)
            term.setCursorPos(w - #numStr, y)
            term.write(numStr)
        end
    end
    
    -- Scroll Bar Hint
    if scroll > 0 then 
        term.setCursorPos(w, 2); term.setBackgroundColor(colors.black); term.write("^") 
    end
    if scroll + visibleCount < #floorList then
        term.setCursorPos(w, h); term.setBackgroundColor(colors.black); term.write("v") 
    end
end

local function drawPin()
    clear(colors.gray)
    center(2, "LOCKED", colors.red, colors.white)
    center(4, target.name, colors.gray, colors.white)
    
    term.setCursorPos(1, 6)
    term.setBackgroundColor(colors.black)
    term.clearLine()
    center(6, pinBuf, colors.black, colors.white)
    
    center(h-2, "Type PIN", colors.gray, colors.lightGray)
end

local function send(item)
    clear(colors.black)
    center(h/2, "CALLING...", colors.black, colors.yellow)
    rednet.send(SERVER_ID, {floor=item.id}, "elevator_request")
    sleep(1)
    state = "list"
    drawList()
end

-- LOGIC
drawList()
while true do
    local event, p1, x, y = os.pullEvent()
    
    if state == "list" then
        if event == "mouse_click" or event == "monitor_touch" then
            -- Scroll Logic (Top/Bottom edges)
            if y == 2 and scroll > 0 then scroll = scroll - 1; drawList()
            elseif y == h and scroll + (h-2) < #floorList then scroll = scroll + 1; drawList()
            
            -- Click Item Logic
            elseif y > 1 and y <= h then
                local listIdx = y - 2
                local realIdx = scroll + listIdx + 1
                local item = floorList[realIdx]
                if item then
                    if item.locked then
                        target = item; state = "pin"; pinBuf = ""; drawPin()
                    else
                        send(item)
                    end
                end
            end
        elseif event == "mouse_scroll" then
            if p1 > 0 and scroll + (h-2) < #floorList then scroll = scroll + 1; drawList()
            elseif p1 < 0 and scroll > 0 then scroll = scroll - 1; drawList() end
        end
        
    elseif state == "pin" then
        if event == "char" then
            if #pinBuf < 4 then pinBuf = pinBuf .. p1; drawPin() end
            if pinBuf == PIN_CODE then send(target) end
        elseif event == "key" and p1 == keys.backspace then
            pinBuf = string.sub(pinBuf, 1, -2); drawPin()
        elseif event == "mouse_click" then
            state = "list"; drawList() -- Click to cancel
        end
    end
end
