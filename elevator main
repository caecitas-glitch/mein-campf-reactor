-- WALL MONITOR SCRIPT (HD Text + Anti-Clip)

-- 1. CONFIGURATION
local floors = {
    [1] = { name = "Lobby",   locked = false },
    [2] = { name = "Storage", locked = false },
    [3] = { name = "Roof",    locked = true, pin = "5555" }
}

-- 2. SETUP
local sides = rs.getSides()
local modemFound = false
for _, side in pairs(sides) do
    if peripheral.getType(side) == "modem" then
        rednet.open(side)
        modemFound = true
        break
    end
end
if not modemFound then pcall(rednet.open, "top") end

local mon = peripheral.find("monitor")
if not mon then error("No Monitor Found") end

-- FIX: Set Scale to 0.5 to fit more text (HD Mode)
mon.setTextScale(0.5)

-- 3. THEME
local theme = {
    bg = colors.gray,
    header_bg = colors.cyan,
    header_text = colors.black,
    btn_bg = colors.black,
    btn_text = colors.white,
    btn_lock = colors.red,
    highlight = colors.lime,
    status_text = colors.lightGray
}

-- 4. HELPERS
local function clearScreen()
    mon.setBackgroundColor(theme.bg)
    mon.clear()
end

local function drawBox(x, y, w, h, color)
    mon.setBackgroundColor(color)
    for i = y, y + h - 1 do
        mon.setCursorPos(x, i)
        mon.write(string.rep(" ", w))
    end
end

local function centerText(y, text, txtColor, bgColor)
    if bgColor then mon.setBackgroundColor(bgColor) end
    local w, h = mon.getSize()
    -- Logic to prevent clipping off the left side
    local x = math.floor((w - #text) / 2) + 1
    if x < 1 then x = 1 end 
    
    mon.setCursorPos(x, y)
    mon.setTextColor(txtColor)
    mon.write(text)
end

local function animatePress(yPos, color)
    local w, h = mon.getSize()
    drawBox(2, yPos, w-2, 1, color)
    sleep(0.1)
end

-- 5. MAIN MENU
local function drawMainMenu(statusMsg)
    clearScreen()
    local w, h = mon.getSize()
    
    -- HEADER
    drawBox(1, 1, w, 3, theme.header_bg) -- Taller header for HD
    centerText(2, "ELEVATOR OS", theme.header_text, theme.header_bg)
    
    -- FLOORS
    for i = 1, #floors do
        local f = floors[i]
        -- Spacing adjusted for 0.5 scale (items need more vertical space)
        local yPos = 4 + (i * 4) 
        
        drawBox(2, yPos, w-2, 3, theme.btn_bg) -- Taller buttons
        
        -- Center the text inside the button vertically
        mon.setCursorPos(4, yPos+1)
        if f.locked then
            mon.setTextColor(theme.btn_lock)
            mon.write(i .. ". " .. f.name .. " [LOCKED]")
        else
            mon.setTextColor(theme.btn_text)
            mon.write(i .. ". " .. f.name)
        end
    end
    
    -- STATUS
    mon.setBackgroundColor(theme.bg)
    centerText(h-1, statusMsg or "READY", theme.status_text)
end

-- 6. KEYPAD UI (HD Layout)
local function drawKeypadUI(targetName, currentPin)
    clearScreen()
    local w, h = mon.getSize()
    
    -- Header
    drawBox(1, 1, w, 3, theme.btn_lock)
    centerText(2, "SECURE: " .. string.sub(targetName, 1, 10), colors.white, theme.btn_lock)
    
    -- PIN Display
    drawBox(4, 5, w-8, 3, colors.black)
    mon.setCursorPos(4, 6)
    mon.setTextColor(colors.white)
    
    local masked = string.rep("*", #currentPin)
    local padding = math.floor(((w-8) - 4)/2)
    if padding < 0 then padding = 0 end
    mon.write(string.rep(" ", padding) .. masked)
    
    -- Keypad Buttons
    -- Dynamic centering for HD
    local btnW = 5
    local btnH = 3
    local gap = 1
    
    local totalW = (btnW * 3) + (gap * 2)
    local startX = math.floor((w - totalW) / 2) + 1
    local startY = 9
    
    local layout = {{7,8,9},{4,5,6},{1,2,3},{-1,0,-2}}
    
    for row = 1, 4 do
        for col = 1, 3 do
            local digit = layout[row][col]
            if digit >= -1 and digit ~= -2 then
                local x = startX + (col-1)*(btnW+gap)
                local y = startY + (row-1)*(btnH+gap)
                
                if y+btnH < h then
                    drawBox(x, y, btnW, btnH, colors.lightGray)
                    mon.setCursorPos(x+2, y+1)
                    mon.setTextColor(colors.black)
                    if digit == -1 then mon.write("C")
                    else mon.write(tostring(digit)) end
                end
            end
        end
    end
end

-- 7. TROLL SEQUENCE (Short Lines for No Clipping)
local function runTrollSequence()
    clearScreen()
    mon.setBackgroundColor(colors.black)
    mon.clear()
    
    mon.setTextColor(colors.red) 
    centerText(2, "Did you actually", colors.red)
    centerText(3, "put the right", colors.red)
    centerText(4, "password?", colors.red)
    
    mon.setTextColor(colors.gray)
    -- Broken into short lines to prevent clipping
    centerText(7, "Its hard to code", colors.gray)
    centerText(8, "a password system", colors.gray)
    centerText(9, "for something", colors.gray)
    centerText(10, "this stupid.", colors.gray)
    
    local w, h = mon.getSize()
    local btnY = h - 3
    
    -- Centered Buttons
    local gap = 4
    local yesX = math.floor(w/2) - 8
    local noX = math.floor(w/2) + 2
    
    drawBox(yesX, btnY, 6, 3, colors.lime)
    mon.setCursorPos(yesX+1, btnY+1)
    mon.setTextColor(colors.black)
    mon.write("YES")
    
    drawBox(noX, btnY, 5, 3, colors.red)
    mon.setCursorPos(noX+1, btnY+1)
    mon.setTextColor(colors.white)
    mon.write("NO")
    
    while true do
        local e, s, x, y = os.pullEvent("monitor_touch")
        if y >= btnY and y <= btnY+3 then
            -- YES
            if x >= yesX and x <= yesX+6 then
                clearScreen()
                centerText(8, "Taking you", colors.lime)
                centerText(9, "to the roof...", colors.lime)
                sleep(3)
                clearScreen()
                centerText(9, "Just kidding.", colors.red)
                sleep(2)
                return
            end
            -- NO
            if x >= noX and x <= noX+5 then return end
        end
    end
end

-- 8. INPUT LOGIC
local function getKeypadTouch(x, y)
    local w, h = mon.getSize()
    
    -- RECALCULATE LAYOUT TO MATCH DRAWING
    local btnW = 5
    local btnH = 3
    local gap = 1
    local totalW = (btnW * 3) + (gap * 2)
    local startX = math.floor((w - totalW) / 2) + 1
    local startY = 9
    
    -- Check bounds
    if x < startX or y < startY then return nil end
    
    local col = math.floor((x - startX) / (btnW + gap)) + 1
    local row = math.floor((y - startY) / (btnH + gap)) + 1
    
    if col >= 1 and col <= 3 and row >= 1 and row <= 4 then
        local layout = {{7,8,9},{4,5,6},{1,2,3},{-1,0,-2}}
        return layout[row][col]
    end
    return nil
end

local function runPinProcess(target)
    local currentPin = ""
    local entering = true
    
    while entering do
        drawKeypadUI(target.name, currentPin)
        local event, side, x, y = os.pullEvent("monitor_touch")
        local digit = getKeypadTouch(x, y)
        
        if digit then
            if digit == -1 then currentPin = ""
            elseif digit >= 0 and #currentPin < 4 then
                currentPin = currentPin .. digit
                if #currentPin == 4 then
                    drawKeypadUI(target.name, currentPin)
                    sleep(0.2)
                    if currentPin == target.pin then
                        return true
                    else
                        runTrollSequence()
                        return false
                    end
                end
            end
        end
    end
    return false
end

-- 9. MAIN LOOPS
local myLabel = os.getComputerLabel()
local myFloorID = tonumber(myLabel)

local function runUI()
    while true do
        drawMainMenu("IDLE - Select Floor")
        local event, side, x, y = os.pullEvent("monitor_touch")
        
        -- Updated hit detection for HD list
        -- List starts at Y=4, items are 4 high (3 box + 1 gap)
        -- Formula: (y - 4) / 4
        local idx = math.floor((y - 4) / 4) + 1 -- Simplified logic
        
        -- Validation
        -- Check if Y is actually inside a button box
        local localY = (y - 4) % 4
        local isInsideBox = (localY >= 0 and localY <= 2)
        
        if isInsideBox and floors[idx] then
            local target = floors[idx]
            animatePress(4 + (idx-1)*4, theme.highlight)
            
            local auth = true
            if target.locked then
                auth = runPinProcess(target)
            end
            
            if auth then
                drawMainMenu("CALLING: " .. target.name)
                rednet.broadcast({ floor = idx }, "elevator_cmd")
                sleep(2)
            end
        end
    end
end

local function runBeacon()
    while true do
        local e, s, sCh, rCh, msg, dist = os.pullEvent("modem_message")
        if type(msg) == "table" and msg.sProtocol == "elevator_ping" and myFloorID then
             rednet.send(msg.nSender, { floor = myFloorID, range = dist }, "elevator_pong")
        end
    end
end

parallel.waitForAny(runUI, runBeacon)
