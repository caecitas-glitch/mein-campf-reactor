-- SERVER SCRIPT (Run at the base of the elevator)
peripheral.find("modem", rednet.open)
print("Elevator Server Online. ID: " .. os.getComputerID())
print("Waiting for signals...")

-- CONFIGURATION
-- This maps the "Floor Number" to the "Computer Side"
-- Make sure your Redstone Links are on these sides!
local floorMap = {
    [1] = "back",   -- Floor 1 (Lobby)
    [2] = "right",  -- Floor 2 (Storage)
    [3] = "left"    -- Floor 3 (Roof)
}

while true do
    -- 1. Listen for the exact protocol used in your client script
    local id, message = rednet.receive("elevator_cmd")
    
    -- 2. Verify the message is correct
    if type(message) == "table" and message.floor then
        local target = message.floor
        local side = floorMap[target]
        
        if side then
            print("Received Call: Sending Elevator to Floor " .. target)
            
            -- 3. Turn ON the signal
            rs.setOutput(side, true)
            
            -- 4. HOLD the signal (CRITICAL STEP)
            -- We hold it for 4 seconds to ensure the Create Elevator 
            -- "wakes up" and realizes it needs to move.
            -- If this is too short, "Calling Down" will fail.
            sleep(4) 
            
            -- 5. Turn OFF the signal
            rs.setOutput(side, false)
            print("Signal ended.")
        else
            print("Error: No side configured for Floor " .. target)
        end
    end
end
